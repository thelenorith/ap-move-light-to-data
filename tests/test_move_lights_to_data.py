"""
Tests for move_lights_to_data module.

Generated By: Claude Code (Claude Sonnet 4.5)
"""

import os
from unittest.mock import patch

from ap_move_lights_to_data import move_lights_to_data


class TestFindLightDirectories:
    """Tests for find_light_directories function."""

    @patch("ap_common.get_filtered_metadata")
    def test_finds_directories_with_light_frames(self, mock_metadata, tmp_path):
        """Verify directories containing LIGHT frames are found."""
        light_dir = str(tmp_path / "10_Blink" / "M31" / "DATE_2024-01-15")
        mock_metadata.return_value = {
            os.path.join(light_dir, "light_001.fits"): {"type": "LIGHT"},
            os.path.join(light_dir, "light_002.fits"): {"type": "LIGHT"},
        }

        result = move_lights_to_data.find_light_directories(str(tmp_path / "10_Blink"))

        assert len(result) == 1
        assert light_dir in result

    @patch("ap_common.get_filtered_metadata")
    def test_finds_multiple_directories(self, mock_metadata, tmp_path):
        """Verify multiple directories with light frames are found."""
        dir1 = str(tmp_path / "10_Blink" / "M31")
        dir2 = str(tmp_path / "10_Blink" / "NGC7000")
        mock_metadata.return_value = {
            os.path.join(dir1, "light_001.fits"): {"type": "LIGHT"},
            os.path.join(dir2, "light_001.xisf"): {"type": "LIGHT"},
        }

        result = move_lights_to_data.find_light_directories(str(tmp_path / "10_Blink"))

        assert len(result) == 2
        assert dir1 in result
        assert dir2 in result

    @patch("ap_common.get_filtered_metadata")
    def test_returns_empty_for_no_light_frames(self, mock_metadata, tmp_path):
        """Verify empty list when no LIGHT frames exist."""
        mock_metadata.return_value = {}

        result = move_lights_to_data.find_light_directories(str(tmp_path / "10_Blink"))

        assert len(result) == 0


class TestGetTargetFromPath:
    """Tests for get_target_from_path function."""

    def test_extracts_relative_path(self, tmp_path):
        """Verify relative path extraction."""
        source = str(tmp_path / "10_Blink")
        light_dir = str(tmp_path / "10_Blink" / "M31" / "DATE_2024-01-15")

        result = move_lights_to_data.get_target_from_path(light_dir, source)

        assert result == os.path.join("M31", "DATE_2024-01-15")

    def test_handles_nested_structure(self, tmp_path):
        """Verify deeply nested structure extraction."""
        source = str(tmp_path / "10_Blink")
        light_dir = str(
            tmp_path / "10_Blink" / "M31" / "DATE_2024-01-15" / "FILTER_Ha_EXP_300"
        )

        result = move_lights_to_data.get_target_from_path(light_dir, source)

        assert "M31" in result
        assert "FILTER_Ha_EXP_300" in result


class TestMoveDirectory:
    """Tests for move_directory function."""

    def test_moves_directory_contents(self, tmp_path):
        """Verify directory is moved with contents."""
        source = tmp_path / "source" / "target"
        source.mkdir(parents=True)
        (source / "file1.fits").touch()
        (source / "file2.fits").touch()

        dest = tmp_path / "dest" / "target"

        result = move_lights_to_data.move_directory(str(source), str(dest))

        assert result is True
        assert dest.exists()
        assert (dest / "file1.fits").exists()
        assert not source.exists()

    def test_dry_run_does_not_move(self, tmp_path):
        """Verify dry run does not actually move files."""
        source = tmp_path / "source"
        source.mkdir()
        (source / "file.fits").touch()

        dest = tmp_path / "dest"

        result = move_lights_to_data.move_directory(
            str(source), str(dest), dry_run=True
        )

        assert result is True
        assert source.exists()
        assert not dest.exists()

    def test_creates_parent_directories(self, tmp_path):
        """Verify parent directories are created."""
        source = tmp_path / "source"
        source.mkdir()
        (source / "file.fits").touch()

        dest = tmp_path / "deep" / "nested" / "path" / "dest"

        result = move_lights_to_data.move_directory(str(source), str(dest))

        assert result is True
        assert dest.exists()


class TestProcessLightDirectories:
    """Tests for process_light_directories function."""

    @patch("ap_move_lights_to_data.move_lights_to_data.check_calibration_status")
    @patch("ap_move_lights_to_data.move_lights_to_data.find_light_directories")
    def test_skips_when_no_darks(self, mock_find, mock_status, tmp_path):
        """Verify directories are skipped when no darks exist."""
        mock_find.return_value = [str(tmp_path / "light_dir")]
        mock_status.return_value = {
            "has_lights": True,
            "has_darks": False,
            "has_flats": True,
            "has_bias": False,
            "needs_bias": False,
            "is_complete": False,
            "light_count": 10,
            "dark_count": 0,
            "flat_count": 5,
            "bias_count": 0,
            "light_metadata": {},
            "reason": "No matching dark frames",
            "skip_reason_code": "no_darks",
            "matched_darks": [],
            "matched_flats": [],
            "matched_bias": [],
        }

        results = move_lights_to_data.process_light_directories(
            str(tmp_path / "10_Blink"),
            str(tmp_path / "20_Data"),
        )

        assert results["skipped_no_darks"] == 1
        assert results["moved"] == 0

    @patch("ap_move_lights_to_data.move_lights_to_data.check_calibration_status")
    @patch("ap_move_lights_to_data.move_lights_to_data.find_light_directories")
    def test_skips_when_no_flats(self, mock_find, mock_status, tmp_path):
        """Verify directories are skipped when no flats exist."""
        mock_find.return_value = [str(tmp_path / "light_dir")]
        mock_status.return_value = {
            "has_lights": True,
            "has_darks": True,
            "has_flats": False,
            "has_bias": False,
            "needs_bias": False,
            "is_complete": False,
            "light_count": 10,
            "dark_count": 5,
            "flat_count": 0,
            "bias_count": 0,
            "light_metadata": {},
            "reason": "No matching flat frames",
            "skip_reason_code": "no_flats",
            "matched_darks": [],
            "matched_flats": [],
            "matched_bias": [],
        }

        results = move_lights_to_data.process_light_directories(
            str(tmp_path / "10_Blink"),
            str(tmp_path / "20_Data"),
        )

        assert results["skipped_no_flats"] == 1
        assert results["moved"] == 0

    @patch("ap_move_lights_to_data.move_lights_to_data.check_calibration_status")
    @patch("ap_move_lights_to_data.move_lights_to_data.find_light_directories")
    def test_skips_when_no_bias_needed(self, mock_find, mock_status, tmp_path):
        """Verify directories are skipped when bias needed but missing."""
        mock_find.return_value = [str(tmp_path / "light_dir")]
        mock_status.return_value = {
            "has_lights": True,
            "has_darks": True,
            "has_flats": True,
            "has_bias": False,
            "needs_bias": True,
            "is_complete": False,
            "light_count": 10,
            "dark_count": 5,
            "flat_count": 5,
            "bias_count": 0,
            "light_metadata": {},
            "reason": "Dark exposure mismatch requires bias, but none found",
            "skip_reason_code": "no_bias",
            "matched_darks": [],
            "matched_flats": [],
            "matched_bias": [],
        }

        results = move_lights_to_data.process_light_directories(
            str(tmp_path / "10_Blink"),
            str(tmp_path / "20_Data"),
        )

        assert results["skipped_no_bias"] == 1
        assert results["moved"] == 0

    @patch("ap_move_lights_to_data.move_lights_to_data.ap_common")
    @patch("ap_move_lights_to_data.move_lights_to_data.move_calibration_files")
    @patch("ap_move_lights_to_data.move_lights_to_data.move_directory")
    @patch("ap_move_lights_to_data.move_lights_to_data.check_calibration_status")
    @patch("ap_move_lights_to_data.move_lights_to_data.find_light_directories")
    def test_moves_when_calibration_complete(
        self,
        mock_find,
        mock_status,
        mock_move,
        mock_move_cal,
        mock_ap_common,
        tmp_path,
    ):
        """Verify directories are moved when calibration is complete."""
        source_dir = tmp_path / "10_Blink"
        light_dir = source_dir / "M31" / "DATE_2024"
        light_dir.mkdir(parents=True)

        mock_find.return_value = [str(light_dir)]
        mock_status.return_value = {
            "has_lights": True,
            "has_darks": True,
            "has_flats": True,
            "has_bias": False,
            "needs_bias": False,
            "is_complete": True,
            "light_count": 10,
            "dark_count": 5,
            "flat_count": 5,
            "bias_count": 0,
            "light_metadata": {},
            "reason": "",
            "matched_darks": [],
            "matched_flats": [],
            "matched_bias": [],
        }
        mock_move.return_value = True
        mock_move_cal.return_value = 0
        mock_ap_common.replace_env_vars.side_effect = lambda x: x

        results = move_lights_to_data.process_light_directories(
            str(source_dir),
            str(tmp_path / "20_Data"),
        )

        assert results["moved"] == 1
        mock_move.assert_called_once()

    @patch("ap_move_lights_to_data.move_lights_to_data.check_calibration_status")
    @patch("ap_move_lights_to_data.move_lights_to_data.find_light_directories")
    def test_skips_when_no_lights(self, mock_find, mock_status, tmp_path):
        """Verify directories are skipped when no light frames found."""
        mock_find.return_value = [str(tmp_path / "some_dir")]
        mock_status.return_value = {
            "has_lights": False,
            "has_darks": False,
            "has_flats": False,
            "has_bias": False,
            "needs_bias": False,
            "is_complete": False,
            "light_count": 0,
            "dark_count": 0,
            "flat_count": 0,
            "bias_count": 0,
            "light_metadata": None,
            "reason": "No light frames found",
            "matched_darks": [],
            "matched_flats": [],
            "matched_bias": [],
        }

        results = move_lights_to_data.process_light_directories(
            str(tmp_path / "10_Blink"),
            str(tmp_path / "20_Data"),
        )

        assert results["skipped_no_lights"] == 1
        assert results["moved"] == 0
